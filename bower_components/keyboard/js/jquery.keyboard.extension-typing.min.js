/* jQuery UI Virtual Keyboard Typing Simulator v1.5 for Keyboard v1.18+ only (11/19/2014)
 * By Rob Garrison ~ MIT license ~ https://github.com/Mottie/Keyboard */
;(function(h){h.fn.addTyping=function(k){var l={showTyping:!0,lockTypeIn:!1,delay:250};return this.each(function(){var c,a=h(this).data("keyboard");a&&(c=a.typing_options=h.extend({},l,k),a.typing_keymap={" ":"space",'"':"34","'":"39","&nbsp;":"space","\b":"bksp","\n":"Enter","\r":"Enter","\t":"tab"},a.typing_xref={8:"bksp",9:"tab",13:"enter",32:"space"},a.typing_event=!1,c.savedLockInput=a.options.lockInput,a.typing_setup=function(){(a.$preview?a.$preview:a.$el).bind("keyup.keyboard",function(b){if(c.init&& c.lockTypeIn)return!1;37<=b.which&&40>=b.which||(16===b.which&&(a.shiftActive=!1),18===b.which&&(a.altActive=!1),16!==b.which&&18!==b.which)||(a.showKeySet(),setTimeout(function(){a.$preview.focus()},200))}).bind("keydown.keyboard",function(b){if(c.init&&c.lockTypeIn)return!1;b.temp=!1;16===b.which&&(b.temp=!a.shiftActive,a.shiftActive=!0);18===b.which&&(b.temp=!a.altActive,a.altActive=!0);b.temp&&(a.showKeySet(),a.$preview.focus());a.typing_event=!0;8!==b.which&&9!==b.which||a.typing_findKey("", b)}).bind("keypress.keyboard",function(b){if(c.init&&c.lockTypeIn)return!1;a.typing_event&&!a.options.lockInput&&a.typing_findKey("",b)})},a.typeIn=function(b,e,f,d){a.isVisible()?a.typing_event?"undefined"===typeof b&&(a.typing_event=!1,a.options.lockInput=c.savedLockInput):(!0!==c.init&&(c.init=!0,a.options.lockInput=c.lockTypeIn,b=c.text=b||"",c.len=b.length,c.delay=e||300,c.current=0,f&&(c.callback=f)),b=c.text.substring(c.current,++c.current),a.typing_findKey(b,d)):(a.typing_event=c.init=!1, a.options.lockInput=c.savedLockInput,clearTimeout(a.typing_timer))},a.typing_findKey=function(b,e){var f,d,g;d=h.keyboard.builtLayouts[a.layout].mappedKeys;g=a.$keyboard.find(".ui-keyboard-keyset");f='.ui-keyboard-button[data-value="'+(a.typing_keymap.hasOwnProperty(b)?a.typing_keymap[b]:b)+'"]';a.typing_event&&e&&(a.typing_xref.hasOwnProperty(e.keyCode||e.which)?f=".ui-keyboard-"+a.typing_xref[e.keyCode||e.which]:(f=String.fromCharCode(e.charCode||e.which),f=d.hasOwnProperty(f)?'.ui-keyboard-button[data-value="'+ d[f]+'"]':".ui-keyboard-"+(e.charCode||e.which)));d=g.filter(":visible").find(f);d.length?a.typing_simulateKey(d,b):(a.typing_event?d=g.find(f):(d=a.typing_keymap.hasOwnProperty(b)?a.typing_keymap[b]:b.charCodeAt(0),"bksp"===d&&(b=d),d=g.find(".ui-keyboard-"+d)),g=d.closest(".ui-keyboard-keyset"),g.attr("name")?(g=g.attr("name"),a.shiftActive=/shift/.test(g),a.altActive=/alt/.test(g),a.metaActive=a.last.keyset[2]=g.match(/meta\d+/)||!1,a.showKeySet({name:a.metaActive}),a.typing_simulateKey(d,b)): a.typing_event||(a.insertText(b),a.checkCombos()));c.current<c.len?a.isVisible()&&setTimeout(function(){a.typeIn()},c.delay):0!==c.len?(a.typing_event=c.init=!1,a.options.lockInput=c.savedLockInput,h.isFunction(c.callback)&&setTimeout(function(){h.isFunction(c.callback)&&c.callback(a)},c.delay)):(c.len=c.current=0,c.text="",a.typing_event=c.init=!1,a.options.lockInput=c.savedLockInput)},a.typing_simulateKey=function(b,e){b.length&&b.filter(":visible").trigger("mouseenter.keyboard");a.typing_timer= setTimeout(function(){b.length&&setTimeout(function(){b.trigger("mouseleave.keyboard")},c.delay/3);a.isVisible()&&!a.typing_event&&(a.insertText(e),a.checkCombos())},c.delay/3)},c.showTyping&&(a.options.alwaysOpen&&a.isVisible()&&a.typing_setup(),a.$el.bind("visible.keyboard",function(){a.typing_setup()})))})}})(jQuery);
